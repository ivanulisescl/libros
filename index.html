<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Biblioteca Personal</title>
    <!-- PWA -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#e94560">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Biblioteca">
    <link rel="apple-touch-icon" href="icon-192.png">
    <!-- Fonts & Scripts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #1a1a2e;
            --secondary: #16213e;
            --accent: #e94560;
            --accent-light: #ff6b6b;
            --text: #eaeaea;
            --text-muted: #a0a0a0;
            --card-bg: #0f0f23;
            --card-hover: #1a1a3e;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --shadow: rgba(0,0,0,0.3);
            --border: rgba(255,255,255,0.05);
            --border-hover: rgba(255,255,255,0.1);
            --success: #43e97b;
            --danger: #ff4757;
            --star: #ffd700;
        }

        [data-theme="light"] {
            --primary: #f5f7fa;
            --secondary: #e8ecf1;
            --text: #2d3748;
            --text-muted: #718096;
            --card-bg: #ffffff;
            --card-hover: #f7fafc;
            --shadow: rgba(0,0,0,0.1);
            --border: rgba(0,0,0,0.08);
            --border-hover: rgba(0,0,0,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--primary);
            color: var(--text);
            min-height: 100vh;
            transition: background 0.3s ease, color 0.3s ease;
        }

        body:not([data-theme="light"]) {
            background-image: 
                radial-gradient(ellipse at 10% 20%, rgba(233, 69, 96, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 90% 80%, rgba(102, 126, 234, 0.1) 0%, transparent 50%);
        }

        /* Header */
        header {
            padding: 2rem 2rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            background: linear-gradient(180deg, var(--secondary) 0%, transparent 100%);
        }

        .header-left h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.3rem;
            background: linear-gradient(135deg, var(--text) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-left p {
            color: var(--text-muted);
            font-size: 1rem;
            font-weight: 300;
        }

        .header-right {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn-icon {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--card-bg);
            color: var(--text);
            padding: 0.7rem 1rem;
            border-radius: 10px;
            cursor: pointer;
            border: 1px solid var(--border);
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-icon:hover {
            border-color: var(--accent);
            background: var(--card-hover);
        }

        .btn-icon.primary {
            background: var(--gradient-1);
            color: white;
            border: none;
        }

        .btn-icon.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-icon.success {
            background: var(--success);
            color: #1a1a2e;
            border: none;
        }

        .btn-icon.success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(67, 233, 123, 0.4);
        }

        /* Botones header (menos llamativos) */
        .btn-soft-add {
            background: #203a2b;
            color: #b7f7d6;
            border: 1px solid rgba(183,247,214,0.25);
        }

        .btn-soft-add:hover {
            border-color: rgba(183,247,214,0.45);
            background: #244032;
        }

        .btn-soft-proximas {
            background: #2a253a;
            color: #e1d7ff;
            border: 1px solid rgba(225,215,255,0.25);
        }

        .btn-soft-proximas:hover {
            border-color: rgba(225,215,255,0.45);
            background: #2f2942;
        }

        /* Pr√≥ximas lecturas - turquesa muy suave */
        /* Pr√≥ximas lecturas - coral opaco, mismo nivel que Editar / A√±adir nota */
        .btn-proximas-accent {
            background: #b55239;
            color: #ffe4dc;
            border: 1px solid rgba(255, 228, 220, 0.3);
        }

        .btn-proximas-accent:hover {
            background: #c45c42;
            border-color: rgba(255, 228, 220, 0.45);
        }

        [data-theme="light"] .btn-proximas-accent {
            background: #c0392b;
            color: #fff0ee;
            border: 1px solid rgba(192, 57, 43, 0.35);
        }

        [data-theme="light"] .btn-proximas-accent:hover {
            background: #d35400;
            border-color: rgba(211, 84, 0, 0.45);
        }

        /* Operaciones Dropdown */
        .operaciones-container {
            position: relative;
        }

        .operaciones-menu {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.5rem;
            min-width: 200px;
            box-shadow: 0 4px 20px var(--shadow);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .operaciones-menu.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .operaciones-menu .btn-icon {
            width: 100%;
            justify-content: flex-start;
            margin-bottom: 0.25rem;
        }

        .operaciones-menu .btn-icon:last-child {
            margin-bottom: 0;
        }

        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--card-bg);
            padding: 0.5rem 1rem;
            border-radius: 30px;
            cursor: pointer;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            border-color: var(--accent);
        }

        .theme-toggle-track {
            width: 50px;
            height: 26px;
            background: var(--secondary);
            border-radius: 13px;
            position: relative;
            transition: background 0.3s ease;
        }

        .theme-toggle-thumb {
            width: 22px;
            height: 22px;
            background: var(--accent);
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        [data-theme="light"] .theme-toggle-thumb {
            transform: translateX(24px);
        }

        .theme-label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 2rem;
            padding: 1.5rem;
            margin: 1rem 2rem;
            background: var(--card-bg);
            border-radius: 16px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            flex-wrap: wrap;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Charts Section */
        .charts-section {
            display: none;
            padding: 0 2rem;
            margin-bottom: 2rem;
        }

        .charts-section.visible {
            display: block;
            animation: slideDown 0.4s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .chart-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .chart-card:hover {
            border-color: var(--border-hover);
            box-shadow: 0 10px 30px var(--shadow);
        }

        .chart-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: var(--text);
        }

        .chart-container {
            position: relative;
            height: 280px;
        }

        /* Controls */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 0 2rem;
            margin-bottom: 2rem;
            justify-content: center;
            align-items: center;
        }

        .search-box {
            position: relative;
            flex: 1;
            max-width: 400px;
        }

        .search-box input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            border: none;
            border-radius: 12px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 1rem;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(233, 69, 96, 0.2);
        }

        .search-box::before {
            content: "üîç";
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1rem;
        }

        select {
            padding: 0.8rem 1.2rem;
            border: none;
            border-radius: 10px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 0.9rem;
            cursor: pointer;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        select:hover {
            border-color: var(--accent);
            background: var(--card-hover);
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            gap: 0.5rem;
            background: var(--card-bg);
            padding: 0.3rem;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .view-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .view-btn.active {
            background: var(--accent);
            color: #fff;
        }

        /* Grid */
        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 1.5rem;
            padding: 0 2rem 3rem;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Book Card */
        .book-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .book-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-1);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .book-card:nth-child(3n+2)::before { background: var(--gradient-2); }
        .book-card:nth-child(3n)::before { background: var(--gradient-3); }

        .book-card:hover {
            transform: translateY(-8px);
            border-color: var(--border-hover);
            box-shadow: 0 20px 40px var(--shadow);
        }

        .book-card:hover::before { opacity: 1; }
        .book-card:hover .book-actions { opacity: 1; }

        .book-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .book-date {
            font-size: 0.75rem;
            color: var(--accent);
            background: rgba(233, 69, 96, 0.15);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            white-space: nowrap;
        }

        .book-pages {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .book-pages span {
            font-weight: 600;
            color: var(--text);
        }

        .book-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            line-height: 1.3;
            color: var(--text);
        }

        .book-author {
            font-size: 1rem;
            color: var(--accent-light);
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        /* Rating */
        .book-rating {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.75rem 0;
        }

        .stars {
            display: flex;
            gap: 2px;
        }

        .star {
            color: var(--text-muted);
            font-size: 1rem;
        }

        .star.filled {
            color: var(--star);
        }

        .rating-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--star);
            background: rgba(255, 215, 0, 0.15);
            padding: 0.2rem 0.5rem;
            border-radius: 6px;
        }

        .no-rating {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-style: italic;
        }

        /* Sinopsis & Comments */
        .book-extras {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .extras-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .extra-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--accent);
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            transition: color 0.2s ease;
        }

        .extra-toggle:hover {
            color: var(--accent-light);
        }

        .extra-toggle.sinopsis-btn {
            color: #667eea;
        }

        .extra-toggle.sinopsis-btn:hover {
            color: #764ba2;
        }

        .extra-text {
            display: none;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-muted);
            line-height: 1.6;
            padding: 0.75rem;
            background: var(--secondary);
            border-radius: 10px;
            white-space: pre-wrap;
        }

        .extra-text.visible {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .extra-text.sinopsis {
            border-left: 3px solid #667eea;
        }

        .extra-text.comment {
            border-left: 3px solid var(--accent);
        }

        .extra-text.citas {
            border-left: 3px solid var(--star);
            padding: 0.75rem;
        }

        .cita-item {
            margin: 0 0 1rem 0;
            padding: 0.75rem 1rem;
            background: transparent !important;
            border: none !important;
            border-radius: 8px;
            font-style: italic;
            color: var(--text);
            line-height: 1.6;
            position: relative;
        }

        .cita-item:last-child {
            margin-bottom: 0;
        }

        .cita-item::before {
            content: "‚ùù";
            position: absolute;
            left: -5px;
            top: -5px;
            font-size: 1.5rem;
            color: var(--star);
            font-style: normal;
        }

        .citas-btn {
            background: linear-gradient(135deg, var(--star) 0%, #ffa500 100%) !important;
            color: #1a1a2e !important;
        }

        .book-actions {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .book-actions button {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .btn-edit {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
        }

        .btn-edit:hover {
            background: #667eea;
            color: white;
        }

        .btn-delete {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
        }

        .btn-delete:hover {
            background: #ff4757;
            color: white;
        }

        /* List View */
        .books-grid.list-view {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .books-grid.list-view .book-card {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            padding: 1rem 1.5rem;
        }

        .books-grid.list-view .book-header { display: none; }
        .books-grid.list-view .book-actions { opacity: 1; position: static; }
        .books-grid.list-view .book-extras { display: none; }

        .books-grid.list-view .book-title {
            font-size: 1.1rem;
            margin-bottom: 0;
        }

        .books-grid.list-view .book-author {
            margin-bottom: 0;
            font-size: 0.9rem;
        }

        .books-grid.list-view .book-rating {
            margin: 0.5rem 0;
        }

        /* No Results */
        .no-results {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
            grid-column: 1 / -1;
        }

        .no-results h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            padding: 1rem;
        }

        .modal-overlay.visible {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 2rem;
            width: 100%;
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: var(--text);
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--secondary);
            color: var(--text);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--accent);
            color: white;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.9rem 1rem;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--secondary);
            color: var(--text);
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }

        /* Star Rating Input */
        .rating-input {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .rating-input input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            height: 8px;
            border-radius: 4px;
            background: var(--secondary);
            outline: none;
        }

        .rating-input input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--star);
            cursor: pointer;
        }

        .rating-input input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--star);
            cursor: pointer;
            border: none;
        }

        .rating-display {
            min-width: 45px;
            text-align: center;
            font-weight: 600;
            color: var(--star);
            font-size: 1.1rem;
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .modal-footer button {
            flex: 1;
            padding: 1rem;
            border-radius: 10px;
            border: none;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel {
            background: var(--secondary);
            color: var(--text);
        }

        .btn-cancel:hover {
            background: var(--card-hover);
        }

        .btn-save {
            background: var(--accent);
            color: white;
        }

        .btn-save:hover {
            background: var(--accent-light);
        }

        /* Botones modal Pr√≥ximas */
        .btn-proxima-eliminar { background: var(--danger) !important; color: white !important; }
        .btn-proxima-empezar { background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%) !important; color: white !important; border: none !important; }
        .btn-proxima-guardar { background: var(--success) !important; color: #1a1a2e !important; border: none !important; }
        .btn-proxima-terminado { background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%) !important; color: white !important; border: none !important; padding: 0.6rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 500; }
        .textarea-sinopsis { min-height: 140px; resize: vertical; }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 30px var(--shadow);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 2000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.visible {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }

        /* Data info */
        .data-info {
            text-align: center;
            padding: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .book-card {
            animation: fadeInUp 0.5s ease forwards;
        }

        /* Pr√≥ximas lecturas */
        .proxima-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--secondary);
            border-radius: 10px;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .proxima-item:hover {
            border-color: var(--accent);
        }

        .proxima-info {
            flex: 1;
        }

        .proxima-titulo {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .proxima-autor {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .proxima-actions {
            display: flex;
            gap: 0.5rem;
        }

        .proxima-btn {
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .proxima-btn.edit {
            background: var(--gradient-1);
            color: white;
        }

        .proxima-btn.edit:hover {
            transform: scale(1.05);
        }

        .proxima-btn.order {
            background: var(--secondary);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 0.4rem 0.5rem;
            font-size: 0.9rem;
        }

        .proxima-btn.order:hover {
            background: var(--card-hover);
            border-color: var(--accent);
        }

        .proxima-btn.order:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .proxima-has-sinopsis {
            font-size: 0.75rem;
            color: var(--accent);
            margin-top: 0.25rem;
        }

        .proximas-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-style: italic;
        }

        /* Leyendo Ahora Section */
        .leyendo-section {
            max-width: 800px;
            margin: 0 auto 1.5rem;
            padding: 0 2rem;
            display: none;
        }

        .leyendo-section.visible {
            display: block;
        }

        .leyendo-card {
            background: linear-gradient(135deg, var(--card-bg) 0%, var(--secondary) 100%);
            border: 2px solid var(--accent);
            border-radius: 16px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .leyendo-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-2);
        }

        .leyendo-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            color: var(--accent);
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .leyendo-titulo {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .leyendo-autor {
            color: var(--text-muted);
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .leyendo-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .leyendo-btn {
            padding: 0.6rem 1rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .leyendo-btn.cita {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            color: #1a1a2e;
        }

        .leyendo-btn.terminado {
            background: var(--success);
            color: #1a1a2e;
        }

        .leyendo-btn.editar {
            background: var(--gradient-1);
            color: white;
        }

        .leyendo-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px var(--shadow);
        }

        /* Modal de opciones */
        .options-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 1px solid var(--border);
        }

        .options-modal.visible {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .options-modal h3 {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .options-modal p {
            color: var(--text-muted);
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }

        .options-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .option-btn {
            padding: 1rem;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .option-btn.empezar {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .option-btn.terminado {
            background: var(--success);
            color: #1a1a2e;
        }

        .option-btn.cancelar {
            background: var(--secondary);
            color: var(--text-muted);
            border: 1px solid var(--border);
        }

        .option-btn:hover {
            transform: translateY(-2px);
        }

        /* Modal a√±adir cita r√°pida */
        .cita-rapida-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            max-width: 500px;
            width: 90%;
            border: 1px solid var(--border);
        }

        .cita-rapida-modal.visible {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .cita-rapida-modal h3 {
            font-family: 'Playfair Display', serif;
            margin-bottom: 1rem;
            color: var(--text);
        }

        .cita-rapida-modal textarea {
            width: 100%;
            min-height: 120px;
            padding: 1rem;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--secondary);
            color: var(--text);
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            margin-bottom: 1rem;
        }

        .cita-rapida-modal textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .cita-rapida-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        /* Responsive */
        @media (max-width: 768px) {
            header { flex-direction: column; text-align: center; }
            .header-left h1 { font-size: 2rem; }
            .header-right { justify-content: center; }
            .operaciones-menu {
                right: auto;
                left: 50%;
                transform: translateX(-50%) translateY(-10px);
            }
            .operaciones-menu.visible {
                transform: translateX(-50%) translateY(0);
            }
            .stats-bar { gap: 1rem; padding: 1rem; }
            .stat-value { font-size: 1.5rem; }
            .controls { flex-direction: column; }
            .search-box { width: 100%; max-width: none; }
            .books-grid { grid-template-columns: 1fr; padding: 0 1rem 2rem; }
            .charts-grid { grid-template-columns: 1fr; }
            .chart-container { height: 250px; }
            .form-row, .form-row-3 { grid-template-columns: 1fr; }
            .book-actions { opacity: 1; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--primary); }
        ::-webkit-scrollbar-thumb { background: var(--secondary); border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <h1>Mi Biblioteca Personal</h1>
            <p>Colecci√≥n de lecturas desde 2023</p>
        </div>
        <div class="header-right">
            <button class="btn-icon btn-proximas-accent" id="proximasBtn">üìö Pr√≥ximas Lecturas</button>
            <button class="btn-icon" id="statsToggle">üìä Estad√≠sticas</button>
            <div class="operaciones-container">
                <button class="btn-icon" id="operacionesBtn">‚öôÔ∏è Operaciones</button>
                <div class="operaciones-menu" id="operacionesMenu">
                    <button class="btn-icon btn-soft-add" id="addBookBtn">‚ûï A√±adir Libro</button>
                    <button class="btn-icon" id="exportBtn">üì§ Exportar</button>
                    <button class="btn-icon" id="importBtn">üì• Importar</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;">
                    <button class="btn-icon" id="resetBtn" title="Recargar datos desde el servidor">üîÑ Resetear</button>
                    <button class="btn-icon" id="updateAppBtn" title="Forzar actualizaci√≥n de la app">üîÑ Actualizar</button>
                </div>
            </div>
            <div class="theme-toggle" id="themeToggle">
                <span class="theme-label">Tema</span>
                <div class="theme-toggle-track">
                    <div class="theme-toggle-thumb">üåô</div>
                </div>
            </div>
        </div>
    </header>

    <div class="stats-bar">
        <div class="stat">
            <div class="stat-value" id="totalBooks">0</div>
            <div class="stat-label">Libros</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="totalPages">0</div>
            <div class="stat-label">P√°ginas</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="totalAuthors">0</div>
            <div class="stat-label">Autores</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="avgRating">-</div>
            <div class="stat-label">Nota Media</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="totalEditorials">0</div>
            <div class="stat-label">Editoriales</div>
        </div>
    </div>

    <!-- Secci√≥n Leyendo Ahora -->
    <section class="leyendo-section" id="leyendoSection">
        <div class="leyendo-card">
            <div class="leyendo-header">üìñ Leyendo ahora</div>
            <div class="leyendo-titulo" id="leyendoTitulo"></div>
            <div class="leyendo-autor" id="leyendoAutor"></div>
            <div class="leyendo-actions">
                <button class="leyendo-btn cita" onclick="abrirCitaRapida()">üí° A√±adir nota</button>
                <button class="leyendo-btn editar" onclick="editarLeyendo()">‚úèÔ∏è Editar</button>
            </div>
        </div>
    </section>

    <!-- Modal opciones al marcar le√≠do -->
    <div class="modal-overlay" id="opcionesOverlay">
        <div class="options-modal" id="opcionesModal">
            <h3>¬øQu√© quieres hacer?</h3>
            <p id="opcionesTitulo"></p>
            <div class="options-buttons">
                <button class="option-btn empezar" onclick="empezarLectura()">üìñ Empezar a leer</button>
                <button class="option-btn terminado" onclick="yaTerminado()">‚úì Ya terminado</button>
                <button class="option-btn cancelar" onclick="cerrarOpciones()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal a√±adir cita r√°pida -->
    <div class="modal-overlay" id="citaRapidaOverlay">
        <div class="cita-rapida-modal" id="citaRapidaModal">
            <h3>üí° A√±adir nota</h3>
            <textarea id="nuevaCita" placeholder="Escribe la nota..."></textarea>
            <div class="cita-rapida-actions">
                <button class="btn-icon" onclick="cerrarCitaRapida()">Cancelar</button>
                <button class="btn-icon primary" onclick="guardarCitaRapida()">Guardar</button>
            </div>
        </div>
    </div>

    <section class="charts-section" id="chartsSection">
        <div class="charts-grid">
            <div class="chart-card">
                <h3 class="chart-title">üìÖ Libros por Mes</h3>
                <div class="chart-container"><canvas id="monthlyChart"></canvas></div>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">üìÜ Libros por A√±o</h3>
                <div class="chart-container"><canvas id="yearlyChart"></canvas></div>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">‚úçÔ∏è Top 10 Autores</h3>
                <div class="chart-container"><canvas id="authorsChart"></canvas></div>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">üè¢ Top 10 Editoriales</h3>
                <div class="chart-container"><canvas id="editorialsChart"></canvas></div>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">‚≠ê Distribuci√≥n de Puntuaciones</h3>
                <div class="chart-container"><canvas id="ratingsChart"></canvas></div>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">üìè Distribuci√≥n por Extensi√≥n</h3>
                <div class="chart-container"><canvas id="lengthChart"></canvas></div>
            </div>
        </div>
    </section>

    <div class="controls">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Buscar por t√≠tulo, autor o editorial...">
        </div>
        <select id="authorFilter"><option value="">Todos los autores</option></select>
        <select id="editorialFilter"><option value="">Todas las editoriales</option></select>
        <select id="yearFilter"><option value="">Todos los a√±os</option></select>
        <select id="ratingFilter">
            <option value="">Todas las puntuaciones</option>
            <option value="10">‚≠ê 10 - Obra maestra</option>
            <option value="9">‚≠ê 9+</option>
            <option value="8">‚≠ê 8+</option>
            <option value="7">‚≠ê 7+</option>
            <option value="6">‚≠ê 6+</option>
            <option value="5">‚≠ê 5+</option>
            <option value="0">Sin puntuar</option>
        </select>
        <select id="sortFilter">
            <option value="date-desc">M√°s recientes</option>
            <option value="date-asc">M√°s antiguos</option>
            <option value="rating-desc">Mejor puntuaci√≥n</option>
            <option value="rating-asc">Peor puntuaci√≥n</option>
            <option value="title">T√≠tulo A-Z</option>
            <option value="author">Autor A-Z</option>
            <option value="pages-desc">M√°s p√°ginas</option>
            <option value="pages-asc">Menos p√°ginas</option>
        </select>
        <div class="view-toggle">
            <button class="view-btn active" data-view="grid" title="Vista cuadr√≠cula">‚ñ¶</button>
            <button class="view-btn" data-view="list" title="Vista lista">‚ò∞</button>
        </div>
    </div>

    <div class="books-grid" id="booksGrid"></div>
    
    <div class="data-info">üíæ Los datos se guardan autom√°ticamente en tu navegador (localStorage) ¬∑ <span id="appVersion">v3.3</span></div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">A√±adir Libro</h2>
                <button class="modal-close" id="modalClose">√ó</button>
            </div>
            <form id="bookForm">
                <input type="hidden" id="bookId">
                <div class="form-group">
                    <label for="titulo">T√≠tulo</label>
                    <input type="text" id="titulo" required placeholder="Ej: Cien a√±os de soledad">
                </div>
                <div class="form-group">
                    <label for="autor">Autor</label>
                    <input type="text" id="autor" required placeholder="Ej: Gabriel Garc√≠a M√°rquez">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="mes">Mes de lectura</label>
                        <select id="mes" required>
                            <option value="Enero">Enero</option>
                            <option value="Febrero">Febrero</option>
                            <option value="Marzo">Marzo</option>
                            <option value="Abril">Abril</option>
                            <option value="Mayo">Mayo</option>
                            <option value="Junio">Junio</option>
                            <option value="Julio">Julio</option>
                            <option value="Agosto">Agosto</option>
                            <option value="Septiembre">Septiembre</option>
                            <option value="Octubre">Octubre</option>
                            <option value="Noviembre">Noviembre</option>
                            <option value="Diciembre">Diciembre</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="anio">A√±o</label>
                        <input type="number" id="anio" required min="2000" max="2100" placeholder="2025">
                    </div>
                </div>
                <div class="form-row-3">
                    <div class="form-group">
                        <label for="paginas">P√°ginas</label>
                        <input type="number" id="paginas" required min="1" placeholder="256">
                    </div>
                    <div class="form-group">
                        <label for="editorial">Editorial</label>
                        <input type="text" id="editorial" required placeholder="Ej: Anagrama">
                    </div>
                    <div class="form-group">
                        <label for="puntuacion">Puntuaci√≥n</label>
                        <div class="rating-input">
                            <input type="range" id="puntuacion" min="0" max="10" value="0" step="1">
                            <span class="rating-display" id="ratingDisplay">-</span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="sinopsis">Sinopsis (opcional)</label>
                    <textarea id="sinopsis" placeholder="Resumen o sinopsis del libro..." rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="comentario">Comentarios (opcional)</label>
                    <textarea id="comentario" placeholder="Tus impresiones sobre el libro..." rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="citas">Notas favoritas (opcional)</label>
                    <textarea id="citas" placeholder="Notas o fragmentos memorables del libro...&#10;&#10;Separa cada nota con una l√≠nea en blanco." rows="4"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" id="cancelBtn">Cancelar</button>
                    <button type="submit" class="btn-save">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Pr√≥ximas Lecturas - Lista -->
    <div class="modal-overlay" id="proximasOverlay">
        <div class="modal" style="max-width: 650px;">
            <div class="modal-header">
                <h2>üìö Pr√≥ximas Lecturas</h2>
                <button class="modal-close" id="proximasClose">√ó</button>
            </div>
            <div id="proximasList" style="margin-bottom: 1rem; max-height: 450px; overflow-y: auto;"></div>
            <button type="button" class="btn-icon primary" id="showAddProximaBtn" style="width: 100%;">‚ûï A√±adir nuevo libro</button>
        </div>
    </div>

    <!-- Modal Editar/A√±adir Pr√≥xima Lectura -->
    <div class="modal-overlay" id="editProximaOverlay">
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header">
                <h2 id="editProximaTitle">Editar Pr√≥xima Lectura</h2>
                <button class="modal-close" id="editProximaClose">√ó</button>
            </div>
            <form id="editProximaForm">
                <input type="hidden" id="editProximaId">
                <div class="form-group">
                    <label for="editProximaTitulo">T√≠tulo</label>
                    <input type="text" id="editProximaTitulo" required placeholder="T√≠tulo del libro">
                </div>
                <div class="form-group">
                    <label for="editProximaAutor">Autor</label>
                    <input type="text" id="editProximaAutor" required placeholder="Nombre del autor">
                </div>
                <div class="form-group">
                    <label for="editProximaSinopsis">Sinopsis (opcional)</label>
                    <textarea id="editProximaSinopsis" placeholder="Resumen o descripci√≥n del libro..." rows="6" class="textarea-sinopsis"></textarea>
                </div>
                <div class="modal-footer" style="flex-wrap: wrap; gap: 0.5rem;">
                    <button type="button" class="btn-cancel btn-proxima-eliminar" id="deleteProximaBtn">üóëÔ∏è Eliminar</button>
                    <button type="button" class="btn-proxima-empezar" id="marcarLeidoBtn">üìñ Empezar a leer</button>
                    <button type="button" class="btn-proxima-terminado" id="terminadoLeyendoBtn" style="display: none;">‚úì Terminado</button>
                    <button type="submit" class="btn-proxima-guardar" id="guardarProximaBtn">üíæ Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <span id="toastIcon">‚úì</span>
        <span id="toastMessage">Mensaje</span>
    </div>

    <script>
        // Storage keys
        const STORAGE_KEY = 'biblioteca_libros_v7';
        const PROXIMAS_KEY = 'biblioteca_proximas_v2';
        const JSON_URL = 'mi_biblioteca.json';

        // Current data
        let libros = [];
        let proximasLecturas = [];
        let libroLeyendo = null;
        let proximaPendiente = null; // Para guardar datos de la pr√≥xima lectura temporalmente
        const LEYENDO_KEY = 'biblioteca_leyendo_v1';

        // Clean old localStorage versions on load
        (function cleanOldStorage() {
            ['biblioteca_libros', 'biblioteca_libros_v2', 'biblioteca_libros_v3', 
             'biblioteca_libros_v4', 'biblioteca_libros_v5', 'biblioteca_libros_v6',
             'biblioteca_proximas_v1'].forEach(key => {
                localStorage.removeItem(key);
            });
        })();

        // Save data to localStorage
        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function saveProximas(data) {
            localStorage.setItem(PROXIMAS_KEY, JSON.stringify(data));
        }

        // Load all data from mi_biblioteca.json
        async function loadFromJSON() {
            try {
                const url = JSON_URL + '?v=' + Date.now();
                console.log('Fetching:', url);
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    console.log('JSON cargado:', data.libros?.length, 'libros,', data.proximas?.length, 'pr√≥ximas');
                    return data;
                }
            } catch (e) {
                console.error('Error cargando JSON:', e);
            }
            return null;
        }

        // Load libros: localStorage first, then JSON file
        async function loadData() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    if (parsed && Array.isArray(parsed) && parsed.length > 0) {
                        console.log('Libros desde localStorage:', parsed.length);
                        return parsed;
                    }
                } catch (e) {}
            }
            return null; // Will be loaded from JSON in initApp
        }

        // Load pr√≥ximas: localStorage first, then JSON file
        async function loadProximas() {
            const stored = localStorage.getItem(PROXIMAS_KEY);
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    if (parsed && Array.isArray(parsed) && parsed.length > 0) {
                        console.log('Pr√≥ximas desde localStorage:', parsed.length);
                        return parsed;
                    }
                } catch (e) {}
            }
            return null; // Will be loaded from JSON in initApp
        }

        // Initialize the app
        async function initApp() {
            try {
                console.log('Iniciando app...');
                
                // Try localStorage first
                libros = await loadData();
                proximasLecturas = await loadProximas();
                
                // If either is empty, load from JSON
                if (!libros || !proximasLecturas) {
                    const jsonData = await loadFromJSON();
                    if (jsonData) {
                        if (!libros && jsonData.libros) {
                            libros = jsonData.libros;
                            saveData(libros);
                        }
                        if (!proximasLecturas && jsonData.proximas) {
                            proximasLecturas = jsonData.proximas;
                            saveProximas(proximasLecturas);
                        }
                        if (jsonData.hasOwnProperty('leyendo')) {
                            libroLeyendo = jsonData.leyendo;
                            saveLeyendo();
                        }
                    }
                }
                
                // Ensure arrays
                libros = libros || [];
                proximasLecturas = proximasLecturas || [];
                
                console.log('Total libros:', libros.length);
                console.log('Total pr√≥ximas:', proximasLecturas.length);
                
                // Load currently reading book
                loadLeyendo();
                renderLeyendo();
                
                initFilters();
                initViewToggle();
                initThemeToggle();
                initStatsToggle();
                filterAndSortBooks();
                console.log('App inicializada correctamente');
            } catch (e) {
                console.error('Error inicializando app:', e);
            }
        }

        // Chart instances
        let charts = {};
        let chartsInitialized = false;

        // Parse date for sorting
        function parseDate(dateStr) {
            const months = {
                'Enero': 0, 'Febrero': 1, 'Marzo': 2, 'Abril': 3,
                'Mayo': 4, 'Junio': 5, 'Julio': 6, 'Agosto': 7,
                'Septiembre': 8, 'Octubre': 9, 'Noviembre': 10, 'Diciembre': 11
            };
            const parts = dateStr.split(' de ');
            const month = months[parts[0]];
            const year = parseInt(parts[1]);
            return new Date(year, month);
        }

        // Get unique values
        function getUniqueValues(arr, key) {
            return [...new Set(arr.map(item => item[key]))].sort();
        }

        function getYears(arr) {
            return [...new Set(arr.map(item => item.fecha.split(' de ')[1]))].sort();
        }

        // Count occurrences
        function countBy(arr, key) {
            return arr.reduce((acc, item) => {
                acc[item[key]] = (acc[item[key]] || 0) + 1;
                return acc;
            }, {});
        }

        // Get chart colors
        function getChartColors(count) {
            const colors = [
                '#e94560', '#667eea', '#4facfe', '#f093fb', '#00f2fe',
                '#ff6b6b', '#764ba2', '#f5576c', '#43e97b', '#fa709a',
                '#fee140', '#6a11cb', '#fc4a1a', '#7f7fd5', '#86a8e7'
            ];
            return colors.slice(0, count);
        }

        function isLightMode() {
            return document.body.getAttribute('data-theme') === 'light';
        }

        function getChartTextColor() {
            return isLightMode() ? '#2d3748' : '#eaeaea';
        }

        function getChartGridColor() {
            return isLightMode() ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)';
        }

        // Render stars
        function renderStars(rating) {
            if (rating === null || rating === undefined) {
                return '<span class="no-rating">Sin puntuar</span>';
            }
            const fullStars = Math.floor(rating / 2);
            const halfStar = rating % 2 >= 1;
            let html = '<div class="stars">';
            for (let i = 0; i < 5; i++) {
                if (i < fullStars) {
                    html += '<span class="star filled">‚òÖ</span>';
                } else if (i === fullStars && halfStar) {
                    html += '<span class="star filled">‚òÖ</span>';
                } else {
                    html += '<span class="star">‚òÜ</span>';
                }
            }
            html += `</div><span class="rating-value">${rating}/10</span>`;
            return html;
        }

        // Initialize Charts
        function initCharts() {
            const textColor = getChartTextColor();
            Chart.defaults.color = textColor;

            // Monthly data
            const monthlyData = {};
            libros.forEach(book => {
                const date = parseDate(book.fecha);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyData[key] = (monthlyData[key] || 0) + 1;
            });
            const sortedMonths = Object.keys(monthlyData).sort();
            const monthLabels = sortedMonths.map(m => {
                const [year, month] = m.split('-');
                const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                return `${monthNames[parseInt(month) - 1]} ${year.slice(2)}`;
            });

            charts.monthly = new Chart(document.getElementById('monthlyChart'), {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: 'Libros',
                        data: sortedMonths.map(m => monthlyData[m]),
                        borderColor: '#e94560',
                        backgroundColor: 'rgba(233, 69, 96, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#e94560',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });

            // Yearly Chart
            const yearlyData = countBy(libros.map(b => ({year: b.fecha.split(' de ')[1]})), 'year');
            const years = Object.keys(yearlyData).sort();
            
            charts.yearly = new Chart(document.getElementById('yearlyChart'), {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Libros',
                        data: years.map(y => yearlyData[y]),
                        backgroundColor: getChartColors(years.length),
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 5 } } }
                }
            });

            // Authors Chart
            const authorCounts = countBy(libros, 'autor');
            const topAuthors = Object.entries(authorCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);

            charts.authors = new Chart(document.getElementById('authorsChart'), {
                type: 'bar',
                data: {
                    labels: topAuthors.map(a => a[0].length > 20 ? a[0].slice(0, 20) + '...' : a[0]),
                    datasets: [{
                        label: 'Libros',
                        data: topAuthors.map(a => a[1]),
                        backgroundColor: getChartColors(10),
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });

            // Editorials Chart
            const editorialCounts = countBy(libros, 'editorial');
            const topEditorials = Object.entries(editorialCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);

            charts.editorials = new Chart(document.getElementById('editorialsChart'), {
                type: 'doughnut',
                data: {
                    labels: topEditorials.map(e => e[0].length > 18 ? e[0].slice(0, 18) + '...' : e[0]),
                    datasets: [{ data: topEditorials.map(e => e[1]), backgroundColor: getChartColors(10), borderWidth: 0 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { boxWidth: 12, padding: 8, font: { size: 11 } } } }
                }
            });

            // Ratings Distribution Chart
            const ratingCounts = {};
            for (let i = 1; i <= 10; i++) ratingCounts[i] = 0;
            ratingCounts['Sin puntuar'] = 0;
            
            libros.forEach(book => {
                if (book.puntuacion !== null && book.puntuacion > 0) {
                    ratingCounts[book.puntuacion]++;
                } else {
                    ratingCounts['Sin puntuar']++;
                }
            });

            const ratingLabels = [...Array(10).keys()].map(i => i + 1);
            const ratingData = ratingLabels.map(r => ratingCounts[r]);

            charts.ratings = new Chart(document.getElementById('ratingsChart'), {
                type: 'bar',
                data: {
                    labels: ratingLabels.map(r => `${r}‚≠ê`),
                    datasets: [{
                        label: 'Libros',
                        data: ratingData,
                        backgroundColor: ratingLabels.map(r => `hsl(${(r - 1) * 12}, 70%, 50%)`),
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });

            // Length Distribution
            const lengthRanges = { 'Cortos (<150)': 0, 'Medios (150-300)': 0, 'Largos (300-500)': 0, 'Muy largos (>500)': 0 };
            libros.forEach(book => {
                if (book.paginas < 150) lengthRanges['Cortos (<150)']++;
                else if (book.paginas < 300) lengthRanges['Medios (150-300)']++;
                else if (book.paginas < 500) lengthRanges['Largos (300-500)']++;
                else lengthRanges['Muy largos (>500)']++;
            });

            charts.length = new Chart(document.getElementById('lengthChart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(lengthRanges),
                    datasets: [{ data: Object.values(lengthRanges), backgroundColor: ['#4facfe', '#667eea', '#e94560', '#f093fb'], borderWidth: 0 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { boxWidth: 12, padding: 10 } } }
                }
            });

            chartsInitialized = true;
        }

        function destroyCharts() {
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
            chartsInitialized = false;
        }

        function updateChartsTheme() {
            const textColor = getChartTextColor();
            const gridColor = getChartGridColor();
            Object.values(charts).forEach(chart => {
                chart.options.scales && Object.values(chart.options.scales).forEach(scale => {
                    scale.ticks = scale.ticks || {};
                    scale.ticks.color = textColor;
                    scale.grid = scale.grid || {};
                    scale.grid.color = gridColor;
                });
                if (chart.options.plugins?.legend) {
                    chart.options.plugins.legend.labels = chart.options.plugins.legend.labels || {};
                    chart.options.plugins.legend.labels.color = textColor;
                }
                chart.update();
            });
        }

        // Initialize filters
        function initFilters() {
            const authorSelect = document.getElementById('authorFilter');
            const editorialSelect = document.getElementById('editorialFilter');
            const yearSelect = document.getElementById('yearFilter');

            authorSelect.innerHTML = '<option value="">Todos los autores</option>';
            editorialSelect.innerHTML = '<option value="">Todas las editoriales</option>';
            yearSelect.innerHTML = '<option value="">Todos los a√±os</option>';

            const authors = getUniqueValues(libros, 'autor');
            const editorials = getUniqueValues(libros, 'editorial');
            const years = getYears(libros);

            authors.forEach(author => {
                authorSelect.innerHTML += `<option value="${author}">${author}</option>`;
            });
            editorials.forEach(editorial => {
                editorialSelect.innerHTML += `<option value="${editorial}">${editorial}</option>`;
            });
            years.forEach(year => {
                yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
            });
        }

        // Update stats
        function updateStats(books) {
            document.getElementById('totalBooks').textContent = books.length;
            document.getElementById('totalPages').textContent = books.reduce((sum, b) => sum + b.paginas, 0).toLocaleString();
            document.getElementById('totalAuthors').textContent = getUniqueValues(books, 'autor').length;
            document.getElementById('totalEditorials').textContent = getUniqueValues(books, 'editorial').length;
            
            // Calculate average rating
            const ratedBooks = books.filter(b => b.puntuacion !== null && b.puntuacion > 0);
            if (ratedBooks.length > 0) {
                const avg = ratedBooks.reduce((sum, b) => sum + b.puntuacion, 0) / ratedBooks.length;
                document.getElementById('avgRating').textContent = avg.toFixed(1);
            } else {
                document.getElementById('avgRating').textContent = '-';
            }
        }

        // Toggle extra content visibility (sinopsis/comment)
        function toggleExtra(index, type) {
            const contentEl = document.getElementById(`${type}-${index}`);
            const toggleBtn = document.getElementById(`toggle-${type}-${index}`);
            const icons = { sinopsis: 'üìñ', comment: 'üí¨', citas: 'üí°' };
            const labels = { sinopsis: 'Sinopsis', comment: 'Comentario', citas: 'Notas' };
            
            if (contentEl.classList.contains('visible')) {
                contentEl.classList.remove('visible');
                toggleBtn.innerHTML = `${icons[type]} ${labels[type]}`;
            } else {
                contentEl.classList.add('visible');
                toggleBtn.innerHTML = `${icons[type]} Ocultar`;
            }
        }

        // Format citas as individual quote blocks
        function formatCitas(citasText) {
            if (!citasText) return '';
            return citasText.split(/\n\s*\n/).filter(c => c.trim()).map(cita => 
                `<blockquote class="cita-item">"${cita.trim()}"</blockquote>`
            ).join('');
        }

        // Render books
        function renderBooks(books) {
            const grid = document.getElementById('booksGrid');
            
            if (books.length === 0) {
                grid.innerHTML = `<div class="no-results"><h3>No se encontraron libros</h3><p>Prueba con otros filtros o a√±ade un nuevo libro</p></div>`;
                return;
            }

            grid.innerHTML = books.map((book) => {
                const realIndex = libros.indexOf(book);
                const hasSinopsis = book.sinopsis && book.sinopsis.trim() !== '';
                const hasComment = book.comentario && book.comentario.trim() !== '';
                const hasCitas = book.citas && book.citas.trim() !== '';
                const hasExtras = hasSinopsis || hasComment || hasCitas;
                
                return `
                <div class="book-card" data-index="${realIndex}">
                    <div class="book-actions">
                        <button class="btn-edit" onclick="editBook(${realIndex})" title="Editar">‚úèÔ∏è</button>
                        <button class="btn-delete" onclick="deleteBook(${realIndex})" title="Eliminar">üóëÔ∏è</button>
                    </div>
                    <div class="book-header">
                        <span class="book-date">${book.fecha}</span>
                        <span class="book-pages"><span>${book.paginas}</span> p√°gs.</span>
                    </div>
                    <h3 class="book-title">${book.titulo}</h3>
                    <p class="book-author">${book.autor}</p>
                    <div class="book-rating">${renderStars(book.puntuacion)}</div>
                    ${hasExtras ? `
                    <div class="book-extras">
                        <div class="extras-buttons">
                            ${hasSinopsis ? `<button class="extra-toggle sinopsis-btn" id="toggle-sinopsis-${realIndex}" onclick="toggleExtra(${realIndex}, 'sinopsis')">üìñ Sinopsis</button>` : ''}
                            ${hasComment ? `<button class="extra-toggle" id="toggle-comment-${realIndex}" onclick="toggleExtra(${realIndex}, 'comment')">üí¨ Comentario</button>` : ''}
                            ${hasCitas ? `<button class="extra-toggle citas-btn" id="toggle-citas-${realIndex}" onclick="toggleExtra(${realIndex}, 'citas')">üí° Notas</button>` : ''}
                        </div>
                        ${hasSinopsis ? `<div class="extra-text sinopsis" id="sinopsis-${realIndex}">${book.sinopsis}</div>` : ''}
                        ${hasComment ? `<div class="extra-text comment" id="comment-${realIndex}">${book.comentario}</div>` : ''}
                        ${hasCitas ? `<div class="extra-text citas" id="citas-${realIndex}">${formatCitas(book.citas)}</div>` : ''}
                    </div>
                    ` : ''}
                </div>
            `}).join('');

            updateStats(books);
        }

        // Filter and sort books
        function filterAndSortBooks() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const authorFilter = document.getElementById('authorFilter').value;
            const editorialFilter = document.getElementById('editorialFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            const ratingFilter = document.getElementById('ratingFilter').value;
            const sortBy = document.getElementById('sortFilter').value;

            let filtered = libros.filter(book => {
                const matchesSearch = !searchTerm || 
                    book.titulo.toLowerCase().includes(searchTerm) ||
                    book.autor.toLowerCase().includes(searchTerm) ||
                    book.editorial.toLowerCase().includes(searchTerm) ||
                    (book.sinopsis && book.sinopsis.toLowerCase().includes(searchTerm)) ||
                    (book.comentario && book.comentario.toLowerCase().includes(searchTerm));
                const matchesAuthor = !authorFilter || book.autor === authorFilter;
                const matchesEditorial = !editorialFilter || book.editorial === editorialFilter;
                const matchesYear = !yearFilter || book.fecha.includes(yearFilter);
                
                let matchesRating = true;
                if (ratingFilter === '0') {
                    matchesRating = book.puntuacion === null || book.puntuacion === 0;
                } else if (ratingFilter) {
                    matchesRating = book.puntuacion !== null && book.puntuacion >= parseInt(ratingFilter);
                }
                
                return matchesSearch && matchesAuthor && matchesEditorial && matchesYear && matchesRating;
            });

            switch(sortBy) {
                case 'date-desc': filtered.sort((a, b) => parseDate(b.fecha) - parseDate(a.fecha)); break;
                case 'date-asc': filtered.sort((a, b) => parseDate(a.fecha) - parseDate(b.fecha)); break;
                case 'rating-desc': filtered.sort((a, b) => (b.puntuacion || 0) - (a.puntuacion || 0)); break;
                case 'rating-asc': filtered.sort((a, b) => (a.puntuacion || 0) - (b.puntuacion || 0)); break;
                case 'title': filtered.sort((a, b) => a.titulo.localeCompare(b.titulo)); break;
                case 'author': filtered.sort((a, b) => a.autor.localeCompare(b.autor)); break;
                case 'pages-desc': filtered.sort((a, b) => b.paginas - a.paginas); break;
                case 'pages-asc': filtered.sort((a, b) => a.paginas - b.paginas); break;
            }

            renderBooks(filtered);
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');
            
            icon.textContent = type === 'success' ? '‚úì' : '‚úï';
            msg.textContent = message;
            toast.className = `toast ${type} visible`;
            
            setTimeout(() => toast.classList.remove('visible'), 3000);
        }

        // Modal functions
        function openModal(title = 'A√±adir Libro') {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalOverlay').classList.add('visible');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('visible');
            document.getElementById('bookForm').reset();
            document.getElementById('bookId').value = '';
            document.getElementById('puntuacion').value = 0;
            updateRatingDisplay(0);
        }

        function updateRatingDisplay(value) {
            const display = document.getElementById('ratingDisplay');
            display.textContent = value == 0 ? '-' : value;
        }

        // Add book
        function addBook(book) {
            libros.push(book);
            saveData(libros);
            initFilters();
            filterAndSortBooks();
            if (chartsInitialized) {
                destroyCharts();
                initCharts();
            }
            showToast('Libro a√±adido correctamente');
        }

        // Edit book
        function editBook(index) {
            const book = libros[index];
            const [mes, anio] = book.fecha.split(' de ');
            
            document.getElementById('bookId').value = index;
            document.getElementById('titulo').value = book.titulo;
            document.getElementById('autor').value = book.autor;
            document.getElementById('mes').value = mes;
            document.getElementById('anio').value = anio;
            document.getElementById('paginas').value = book.paginas;
            document.getElementById('editorial').value = book.editorial;
            document.getElementById('puntuacion').value = book.puntuacion || 0;
            document.getElementById('sinopsis').value = book.sinopsis || '';
            document.getElementById('comentario').value = book.comentario || '';
            document.getElementById('citas').value = book.citas || '';
            updateRatingDisplay(book.puntuacion || 0);
            
            openModal('Editar Libro');
        }

        // Update book
        function updateBook(index, book) {
            libros[index] = book;
            saveData(libros);
            initFilters();
            filterAndSortBooks();
            if (chartsInitialized) {
                destroyCharts();
                initCharts();
            }
            showToast('Libro actualizado correctamente');
        }

        // Delete book
        function deleteBook(index) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este libro?')) {
                libros.splice(index, 1);
                saveData(libros);
                initFilters();
                filterAndSortBooks();
                if (chartsInitialized) {
                    destroyCharts();
                    initCharts();
                }
                showToast('Libro eliminado');
            }
        }

        // Export data
        function exportData() {
            const dataStr = JSON.stringify({ 
                libros: libros,
                proximas: proximasLecturas,
                leyendo: libroLeyendo
            }, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mi_biblioteca.json';
            a.click();
            URL.revokeObjectURL(url);
            const leyendoMsg = libroLeyendo ? ' + leyendo' : '';
            showToast(`Exportados: ${libros.length} libros + ${proximasLecturas.length} pr√≥ximas${leyendoMsg}`);
        }

        // Import data
        function importData(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    let importedBooks = 0;
                    let importedProximas = 0;

                    // Import libros
                    if (data.libros && Array.isArray(data.libros)) {
                        if (confirm(`Se importar√°n ${data.libros.length} libros. ¬øQuieres reemplazar los datos actuales o a√±adirlos?\n\nAceptar = Reemplazar\nCancelar = A√±adir`)) {
                            libros = data.libros.map(b => ({
                                ...b,
                                puntuacion: b.puntuacion ?? null,
                                comentario: b.comentario ?? "",
                                sinopsis: b.sinopsis ?? ""
                            }));
                        } else {
                            const newBooks = data.libros.map(b => ({
                                ...b,
                                puntuacion: b.puntuacion ?? null,
                                comentario: b.comentario ?? "",
                                sinopsis: b.sinopsis ?? ""
                            }));
                            libros = [...libros, ...newBooks];
                        }
                        saveData(libros);
                        initFilters();
                        filterAndSortBooks();
                        if (chartsInitialized) {
                            destroyCharts();
                            initCharts();
                        }
                        importedBooks = data.libros.length;
                    }

                    // Import pr√≥ximas
                    if (data.proximas && Array.isArray(data.proximas)) {
                        proximasLecturas = data.proximas;
                        saveProximas(proximasLecturas);
                        importedProximas = data.proximas.length;
                    }

                    // Import leyendo ahora
                    if (data.hasOwnProperty('leyendo')) {
                        libroLeyendo = data.leyendo;
                        saveLeyendo();
                        renderLeyendo();
                    }

                    if (importedBooks > 0 || importedProximas > 0 || data.hasOwnProperty('leyendo')) {
                        const leyendoMsg = data.leyendo ? ' + leyendo' : '';
                        showToast(`Importados: ${importedBooks} libros + ${importedProximas} pr√≥ximas${leyendoMsg}`);
                    } else {
                        showToast('Formato de archivo no v√°lido', 'error');
                    }
                } catch (err) {
                    showToast('Error al leer el archivo', 'error');
                }
            };
            reader.readAsText(file);
        }

        // View toggle
        function initViewToggle() {
            const viewBtns = document.querySelectorAll('.view-btn');
            const grid = document.getElementById('booksGrid');

            viewBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    viewBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    grid.classList.toggle('list-view', btn.dataset.view === 'list');
                });
            });
        }

        // Theme toggle
        function initThemeToggle() {
            const toggle = document.getElementById('themeToggle');
            const thumb = toggle.querySelector('.theme-toggle-thumb');
            
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.setAttribute('data-theme', 'light');
                thumb.textContent = '‚òÄÔ∏è';
            }

            toggle.addEventListener('click', () => {
                const isLight = document.body.getAttribute('data-theme') === 'light';
                if (isLight) {
                    document.body.removeAttribute('data-theme');
                    thumb.textContent = 'üåô';
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.body.setAttribute('data-theme', 'light');
                    thumb.textContent = '‚òÄÔ∏è';
                    localStorage.setItem('theme', 'light');
                }
                if (chartsInitialized) updateChartsTheme();
            });
        }

        // Stats toggle
        function initStatsToggle() {
            const btn = document.getElementById('statsToggle');
            const section = document.getElementById('chartsSection');

            btn.addEventListener('click', () => {
                const isVisible = section.classList.contains('visible');
                if (isVisible) {
                    section.classList.remove('visible');
                    btn.innerHTML = 'üìä Estad√≠sticas';
                } else {
                    section.classList.add('visible');
                    btn.innerHTML = 'üìä Ocultar';
                    if (!chartsInitialized) initCharts();
                }
            });
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', filterAndSortBooks);
        document.getElementById('authorFilter').addEventListener('change', filterAndSortBooks);
        document.getElementById('editorialFilter').addEventListener('change', filterAndSortBooks);
        document.getElementById('yearFilter').addEventListener('change', filterAndSortBooks);
        document.getElementById('ratingFilter').addEventListener('change', filterAndSortBooks);
        document.getElementById('sortFilter').addEventListener('change', filterAndSortBooks);

        document.getElementById('addBookBtn').addEventListener('click', () => openModal('A√±adir Libro'));
        document.getElementById('modalClose').addEventListener('click', closeModal);
        document.getElementById('cancelBtn').addEventListener('click', closeModal);
        document.getElementById('modalOverlay').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeModal();
        });

        document.getElementById('puntuacion').addEventListener('input', (e) => {
            updateRatingDisplay(e.target.value);
        });

        document.getElementById('bookForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const puntuacionVal = parseInt(document.getElementById('puntuacion').value);
            const book = {
                titulo: document.getElementById('titulo').value.toUpperCase(),
                autor: document.getElementById('autor').value.toUpperCase(),
                fecha: `${document.getElementById('mes').value} de ${document.getElementById('anio').value}`,
                paginas: parseInt(document.getElementById('paginas').value),
                editorial: document.getElementById('editorial').value,
                puntuacion: puntuacionVal === 0 ? null : puntuacionVal,
                sinopsis: document.getElementById('sinopsis').value.trim(),
                comentario: document.getElementById('comentario').value.trim(),
                citas: document.getElementById('citas').value.trim()
            };
            
            const bookId = document.getElementById('bookId').value;
            if (bookId !== '') {
                updateBook(parseInt(bookId), book);
            } else {
                addBook(book);
            }
            closeModal();
        });

        // Operaciones menu toggle
        document.getElementById('operacionesBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            const menu = document.getElementById('operacionesMenu');
            menu.classList.toggle('visible');
        });

        // Close operaciones menu when clicking outside
        document.addEventListener('click', (e) => {
            const container = document.querySelector('.operaciones-container');
            const menu = document.getElementById('operacionesMenu');
            if (container && menu && !container.contains(e.target)) {
                menu.classList.remove('visible');
            }
        });

        document.getElementById('exportBtn').addEventListener('click', () => {
            exportData();
            document.getElementById('operacionesMenu').classList.remove('visible');
        });
        document.getElementById('importBtn').addEventListener('click', () => {
            document.getElementById('importFile').click();
        });
        document.getElementById('importFile').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                importData(e.target.files[0]);
                e.target.value = '';
                document.getElementById('operacionesMenu').classList.remove('visible');
            }
        });

        // Reset data from server
        async function resetData() {
            if (confirm('¬øEst√°s seguro?\n\nEsto borrar√° tus datos locales y recargar√° desde el servidor.\n\nSi has hecho cambios locales que no has exportado, se perder√°n.')) {
                // Clear localStorage
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(PROXIMAS_KEY);
                localStorage.removeItem(LEYENDO_KEY);
                
                // Reload from JSON
                try {
                    const jsonData = await loadFromJSON();
                    if (jsonData) {
                        if (jsonData.libros) {
                            libros = jsonData.libros;
                            saveData(libros);
                        }
                        if (jsonData.proximas) {
                            proximasLecturas = jsonData.proximas;
                            saveProximas(proximasLecturas);
                        }
                        if (jsonData.hasOwnProperty('leyendo')) {
                            libroLeyendo = jsonData.leyendo;
                            saveLeyendo();
                        } else {
                            libroLeyendo = null;
                        }
                        renderLeyendo();
                        initFilters();
                        filterAndSortBooks();
                        if (chartsInitialized) {
                            destroyCharts();
                            initCharts();
                        }
                        const leyendoMsg = libroLeyendo ? ' + leyendo' : '';
                        showToast(`Recargados: ${libros.length} libros + ${proximasLecturas.length} pr√≥ximas${leyendoMsg}`);
                    } else {
                        showToast('Error: No se encontraron datos en el servidor', 'error');
                    }
                } catch (e) {
                    showToast('Error al cargar datos del servidor', 'error');
                    console.error(e);
                }
            }
        }

        document.getElementById('resetBtn').addEventListener('click', () => {
            resetData();
            document.getElementById('operacionesMenu').classList.remove('visible');
        });

        // Forzar actualizaci√≥n de la app (desregistrar SW y recargar)
        document.getElementById('updateAppBtn').addEventListener('click', async () => {
            document.getElementById('operacionesMenu').classList.remove('visible');
            if ('serviceWorker' in navigator) {
                const regs = await navigator.serviceWorker.getRegistrations();
                for (const reg of regs) await reg.unregister();
            }
            showToast('Actualizando...');
            setTimeout(() => window.location.reload(true), 500);
        });

        // ========== PR√ìXIMAS LECTURAS - UI ==========

        let currentEditProximaIndex = -1;

        // Render pr√≥ximas list
        function renderProximas() {
            const container = document.getElementById('proximasList');
            if (proximasLecturas.length === 0) {
                container.innerHTML = '<div class="proximas-empty">No hay libros en la lista</div>';
                return;
            }
            container.innerHTML = proximasLecturas.map((libro, index) => `
                <div class="proxima-item" onclick="editarProxima(${index})" style="cursor: pointer;">
                    <div class="proxima-info">
                        <div class="proxima-titulo">${libro.titulo}</div>
                        <div class="proxima-autor">${libro.autor}</div>
                        ${libro.sinopsis ? '<div class="proxima-has-sinopsis">üìñ Tiene sinopsis</div>' : ''}
                    </div>
                    <div class="proxima-actions">
                        <button class="proxima-btn order" onclick="event.stopPropagation(); moverProxima(${index}, 'arriba')" title="Subir" ${index === 0 ? 'disabled' : ''}>‚ñ≤</button>
                        <button class="proxima-btn order" onclick="event.stopPropagation(); moverProxima(${index}, 'abajo')" title="Bajar" ${index === proximasLecturas.length - 1 ? 'disabled' : ''}>‚ñº</button>
                        <button class="proxima-btn edit" onclick="event.stopPropagation(); editarProxima(${index})" title="Editar">‚úèÔ∏è Editar</button>
                    </div>
                </div>
            `).join('');
        }

        // Mover pr√≥xima lectura arriba o abajo
        function moverProxima(index, direccion) {
            if (direccion === 'arriba' && index === 0) return;
            if (direccion === 'abajo' && index === proximasLecturas.length - 1) return;
            
            const nuevoIndex = direccion === 'arriba' ? index - 1 : index + 1;
            const libro = proximasLecturas[index];
            
            // Intercambiar posiciones
            proximasLecturas[index] = proximasLecturas[nuevoIndex];
            proximasLecturas[nuevoIndex] = libro;
            
            saveProximas(proximasLecturas);
            renderProximas();
            showToast(`Libro movido ${direccion === 'arriba' ? 'arriba' : 'abajo'}`);
        }

        // Open edit modal for a pr√≥xima
        function editarProxima(index) {
            currentEditProximaIndex = index;
            const libro = proximasLecturas[index];
            document.getElementById('editProximaTitle').textContent = 'Editar Pr√≥xima Lectura';
            document.getElementById('editProximaId').value = index;
            document.getElementById('editProximaTitulo').value = libro.titulo;
            document.getElementById('editProximaAutor').value = libro.autor;
            document.getElementById('editProximaSinopsis').value = libro.sinopsis || '';
            document.getElementById('deleteProximaBtn').style.display = 'inline-flex';
            document.getElementById('marcarLeidoBtn').style.display = 'inline-flex';
            document.getElementById('terminadoLeyendoBtn').style.display = 'none';
            document.getElementById('editProximaOverlay').classList.add('visible');
        }

        // Open add new pr√≥xima modal
        function addNuevaProxima() {
            currentEditProximaIndex = -1;
            document.getElementById('editProximaTitle').textContent = 'A√±adir Pr√≥xima Lectura';
            document.getElementById('editProximaForm').reset();
            document.getElementById('editProximaId').value = '';
            document.getElementById('deleteProximaBtn').style.display = 'none';
            document.getElementById('marcarLeidoBtn').style.display = 'none';
            document.getElementById('terminadoLeyendoBtn').style.display = 'none';
            document.getElementById('editProximaOverlay').classList.add('visible');
            document.getElementById('editProximaTitulo').focus();
        }

        // Save pr√≥xima (add or update)
        function guardarProxima() {
            const titulo = document.getElementById('editProximaTitulo').value.trim();
            const autor = document.getElementById('editProximaAutor').value.trim();
            const sinopsis = document.getElementById('editProximaSinopsis').value.trim();
            
            if (!titulo || !autor) return;
            
            // Special case: editing "leyendo" book
            if (currentEditProximaIndex === -999) {
                libroLeyendo.titulo = titulo.toUpperCase();
                libroLeyendo.autor = autor.toUpperCase();
                libroLeyendo.sinopsis = sinopsis;
                saveLeyendo();
                renderLeyendo();
                showToast('Libro actualizado');
                document.getElementById('editProximaOverlay').classList.remove('visible');
                return;
            }
            
            const libro = {
                titulo: titulo.toUpperCase(),
                autor: autor.toUpperCase(),
                sinopsis: sinopsis
            };
            
            if (currentEditProximaIndex >= 0) {
                proximasLecturas[currentEditProximaIndex] = libro;
                showToast('Libro actualizado');
            } else {
                proximasLecturas.push(libro);
                showToast('Libro a√±adido a pr√≥ximas lecturas');
            }
            
            saveProximas(proximasLecturas);
            renderProximas();
            document.getElementById('editProximaOverlay').classList.remove('visible');
        }

        // Delete from pr√≥ximas
        function eliminarProximaActual() {
            if (currentEditProximaIndex < 0) return;
            if (!confirm('¬øEliminar este libro de la lista?')) return;
            
            const libro = proximasLecturas[currentEditProximaIndex];
            proximasLecturas.splice(currentEditProximaIndex, 1);
            saveProximas(proximasLecturas);
            renderProximas();
            document.getElementById('editProximaOverlay').classList.remove('visible');
            showToast(`"${libro.titulo}" eliminado`);
        }

        // Mark as read - opens the add book modal with data
        function marcarLeidoActual() {
            if (currentEditProximaIndex < 0) return;
            
            const titulo = document.getElementById('editProximaTitulo').value.trim();
            const autor = document.getElementById('editProximaAutor').value.trim();
            const sinopsis = document.getElementById('editProximaSinopsis').value.trim();
            if (!titulo || !autor) return;
            
            if (libroLeyendo && !confirm('Ya tienes un libro en lectura. ¬øReemplazarlo?')) return;
            
            libroLeyendo = {
                titulo: titulo.toUpperCase(),
                autor: autor.toUpperCase(),
                sinopsis: sinopsis,
                citas: '',
                fechaInicio: new Date().toISOString()
            };
            saveLeyendo();
            renderLeyendo();
            
            proximasLecturas.splice(currentEditProximaIndex, 1);
            saveProximas(proximasLecturas);
            renderProximas();
            
            document.getElementById('editProximaOverlay').classList.remove('visible');
            document.getElementById('proximasOverlay').classList.remove('visible');
            showToast('¬°A disfrutar de la lectura! üìñ');
        }

        function cerrarOpciones() {
            document.getElementById('opcionesOverlay').classList.remove('visible');
            document.getElementById('opcionesModal').classList.remove('visible');
            proximaPendiente = null;
        }

        function empezarLectura() {
            if (!proximaPendiente) return;
            
            // Si ya hay un libro leyendo, preguntar
            if (libroLeyendo) {
                if (!confirm('Ya tienes un libro en lectura. ¬øQuieres reemplazarlo?')) {
                    cerrarOpciones();
                    return;
                }
            }
            
            // Set as currently reading
            libroLeyendo = {
                titulo: proximaPendiente.titulo.toUpperCase(),
                autor: proximaPendiente.autor.toUpperCase(),
                sinopsis: proximaPendiente.sinopsis,
                citas: '',
                fechaInicio: new Date().toISOString()
            };
            saveLeyendo();
            renderLeyendo();
            
            // Remove from pr√≥ximas
            proximasLecturas.splice(proximaPendiente.index, 1);
            saveProximas(proximasLecturas);
            renderProximas();
            
            cerrarOpciones();
            document.getElementById('proximasOverlay').classList.remove('visible');
            showToast('¬°A disfrutar de la lectura! üìñ');
        }

        function yaTerminado() {
            if (!proximaPendiente) return;
            
            // Close options and pr√≥ximas modals
            cerrarOpciones();
            document.getElementById('proximasOverlay').classList.remove('visible');
            
            // Open add book modal with pre-filled data
            document.getElementById('modalTitle').textContent = 'A√±adir Libro Le√≠do';
            document.getElementById('bookForm').reset();
            document.getElementById('bookId').value = '';
            document.getElementById('titulo').value = proximaPendiente.titulo.toUpperCase();
            document.getElementById('autor').value = proximaPendiente.autor.toUpperCase();
            document.getElementById('sinopsis').value = proximaPendiente.sinopsis;
            
            // Set current month/year
            const now = new Date();
            document.getElementById('mes').value = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'][now.getMonth()];
            document.getElementById('anio').value = now.getFullYear();
            document.getElementById('puntuacion').value = 0;
            updateRatingDisplay(0);
            document.getElementById('modalOverlay').classList.add('visible');
            
            // Remove from pr√≥ximas
            proximasLecturas.splice(proximaPendiente.index, 1);
            saveProximas(proximasLecturas);
        }

        // Funciones para "Leyendo ahora"
        function saveLeyendo() {
            localStorage.setItem(LEYENDO_KEY, JSON.stringify(libroLeyendo));
        }

        function loadLeyendo() {
            const data = localStorage.getItem(LEYENDO_KEY);
            if (data) {
                libroLeyendo = JSON.parse(data);
            }
        }

        function renderLeyendo() {
            const section = document.getElementById('leyendoSection');
            if (libroLeyendo) {
                document.getElementById('leyendoTitulo').textContent = libroLeyendo.titulo;
                document.getElementById('leyendoAutor').textContent = libroLeyendo.autor;
                section.classList.add('visible');
            } else {
                section.classList.remove('visible');
            }
        }

        function abrirCitaRapida() {
            document.getElementById('nuevaCita').value = '';
            document.getElementById('citaRapidaOverlay').classList.add('visible');
            document.getElementById('citaRapidaModal').classList.add('visible');
            document.getElementById('nuevaCita').focus();
        }

        function cerrarCitaRapida() {
            document.getElementById('citaRapidaOverlay').classList.remove('visible');
            document.getElementById('citaRapidaModal').classList.remove('visible');
        }

        function guardarCitaRapida() {
            const nuevaCita = document.getElementById('nuevaCita').value.trim();
            if (!nuevaCita) {
                showToast('Escribe una nota', 'error');
                return;
            }
            
            if (libroLeyendo.citas) {
                libroLeyendo.citas += '\n\n' + nuevaCita;
            } else {
                libroLeyendo.citas = nuevaCita;
            }
            saveLeyendo();
            cerrarCitaRapida();
            showToast('Nota guardada üí°');
        }

        function terminarLectura() {
            if (!libroLeyendo) return;
            
            // Open add book modal with pre-filled data
            document.getElementById('modalTitle').textContent = 'A√±adir Libro Le√≠do';
            document.getElementById('bookForm').reset();
            document.getElementById('bookId').value = '';
            document.getElementById('titulo').value = libroLeyendo.titulo;
            document.getElementById('autor').value = libroLeyendo.autor;
            document.getElementById('sinopsis').value = libroLeyendo.sinopsis || '';
            document.getElementById('citas').value = libroLeyendo.citas || '';
            
            // Set current month/year
            const now = new Date();
            document.getElementById('mes').value = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'][now.getMonth()];
            document.getElementById('anio').value = now.getFullYear();
            document.getElementById('puntuacion').value = 0;
            updateRatingDisplay(0);
            document.getElementById('modalOverlay').classList.add('visible');
            
            // Clear leyendo
            libroLeyendo = null;
            localStorage.removeItem(LEYENDO_KEY);
            renderLeyendo();
        }

        function editarLeyendo() {
            document.getElementById('editProximaTitle').textContent = 'Editar Libro en Lectura';
            document.getElementById('editProximaTitulo').value = libroLeyendo.titulo;
            document.getElementById('editProximaAutor').value = libroLeyendo.autor;
            document.getElementById('editProximaSinopsis').value = libroLeyendo.sinopsis || '';
            
            document.getElementById('deleteProximaBtn').style.display = 'none';
            document.getElementById('marcarLeidoBtn').style.display = 'none';
            document.getElementById('terminadoLeyendoBtn').style.display = 'inline-flex';
            
            currentEditProximaIndex = -999;
            document.getElementById('editProximaOverlay').classList.add('visible');
        }

        // Pr√≥ximas list modal events
        document.getElementById('proximasBtn').addEventListener('click', async () => {
            proximasLecturas = await loadProximas();
            renderProximas();
            document.getElementById('proximasOverlay').classList.add('visible');
        });

        document.getElementById('proximasClose').addEventListener('click', () => {
            document.getElementById('proximasOverlay').classList.remove('visible');
        });

        document.getElementById('proximasOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'proximasOverlay') {
                document.getElementById('proximasOverlay').classList.remove('visible');
            }
        });

        document.getElementById('showAddProximaBtn').addEventListener('click', addNuevaProxima);

        // Edit pr√≥xima modal events
        document.getElementById('editProximaClose').addEventListener('click', () => {
            document.getElementById('editProximaOverlay').classList.remove('visible');
        });

        document.getElementById('editProximaOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'editProximaOverlay') {
                document.getElementById('editProximaOverlay').classList.remove('visible');
            }
        });

        document.getElementById('editProximaForm').addEventListener('submit', (e) => {
            e.preventDefault();
            guardarProxima();
        });

        document.getElementById('deleteProximaBtn').addEventListener('click', eliminarProximaActual);
        document.getElementById('marcarLeidoBtn').addEventListener('click', marcarLeidoActual);
        document.getElementById('terminadoLeyendoBtn').addEventListener('click', () => {
            document.getElementById('editProximaOverlay').classList.remove('visible');
            terminarLectura();
        });

        // Close modals on overlay click
        document.getElementById('opcionesOverlay').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) cerrarOpciones();
        });
        document.getElementById('citaRapidaOverlay').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) cerrarCitaRapida();
        });

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker registrado'))
                .catch(err => console.log('Error SW:', err));
        }

        // Initialize app
        initApp();
    </script>
</body>
</html>
